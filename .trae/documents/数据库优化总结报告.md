# 数据库优化总结报告

本报告基于前端实际功能与引用情况，对 Supabase 后端数据库进行全面梳理与清理，统一表结构、索引与 RLS 策略，移除重复/未使用的库表，并补齐前端所需的缺失表。

---

## 1. 保留表清单与说明（按领域）

- 基础主体
  - `users`：系统用户（含角色/部门等基础信息）。
  - `departments`：部门组织架构。
- 评分与考核
  - `score_types`：评分类型字典。
  - `scores`：日常评分记录。
  - `evaluations`：综合评估记录（通用条目）。
  - `performance_evaluations`：绩效评估主记录。
  - `final_performance_scores`：绩效最终得分与汇总。
  - `evaluation_batches`：评估批次管理。
  - `weight_settings`：各评估维度权重设置。
- 奖惩模块
  - `reward_types`：奖惩类型字典。
  - `rewards`：奖惩事件主表（如奖励/扣分）。
  - `reward_applications`：奖惩申请记录。
  - `reward_approval_flows`：奖惩审批流程。
  - `reward_score_records`：奖惩得分明细关联。
  - `monthly_reward_summary`：奖惩月度汇总。
- 工作与重点工作
  - `work_tasks`：工作任务。
  - `work_task_evaluations`：任务考核记录。
  - `work_task_detailed_evaluations`：任务细项考核明细。
  - `key_works`：重点工作主表。
  - `key_work_participants`：重点工作参与者。
  - `key_work_evaluations`：重点工作评估记录。
  - `key_work_milestones`：重点工作里程碑。
- 日/月/年汇总
  - `daily_performance_summary`：日常绩效汇总。
  - `monthly_performance_summary`：月度绩效汇总。
  - `annual_collective_summary`：年度集体汇总。
- 权限与菜单
  - `permissions`、`role_permissions`、`user_permissions`：权限模型与授权关系。
  - `menus`：前端菜单/路由权限映射。
  - `permission_settings`：统一的权限可见性/策略设置。
- 前端引用补齐的最小可用表
  - `announcements`：通知公告，支持时间窗与优先级。
  - `operation_logs`：基础操作审计日志。
  - `key_work_progress`：重点工作进度上报与查询。
- 备份表（用于历史保留/回滚参考）
  - `backup_final_work_performance_scores`
  - `backup_evaluation_visibility_settings`
  - `backup_system_roles`
  - `backup_system_role_permissions`
  - `backup_user_system_roles`

---

## 2. 已移除的重复/未用表清单

- `final_work_performance_scores`（与 `final_performance_scores` 重复）
- `evaluation_visibility_settings`（由 `permission_settings` 统一管理）
- `system_roles`、`system_role_permissions`、`user_system_roles`（概念上与现有权限体系重复，前端未用）

所有移除前均已通过 `backup_*` 表完整备份数据。

---

## 3. 新增的缺失表

- `announcements`
  - 字段：`title`, `content`, `type`, `priority`, `is_read`, `starts_at`, `ends_at`, `created_at`, `updated_at`, `created_by`
  - 外键：`created_by → users(id)`
  - 索引：`created_at`, `priority`, `is_read`, `(starts_at, ends_at)`
  - RLS：认证用户可读；管理员可写
- `operation_logs`
  - 字段：`action`, `details(jsonb)`, `user_id`, `created_at`
  - 外键：`user_id → users(id)`
  - 索引：`created_at`, `user_id`
  - RLS：本人与管理员可读；本人可插入；管理员可更新/删除
- `key_work_progress`
  - 字段：`key_work_id`, `progress_description`, `completion_percentage(0-100)`, `attachments(text[])`, `reported_by`, `reported_at`
  - 外键：`key_work_id → key_works(id)`, `reported_by → users(id)`
  - 索引：`(key_work_id, reported_at desc)`, `reported_by`
  - RLS：报告人或关键工作所有者可写；相关参与者/同部门成员可读

---

## 4. 索引优化总结

- 已建立/补充的关键索引（示例）
  - 时间序列：`created_at`, `reported_at`，常用于倒序列表
  - 关联查询：`user_id`, `department_id`, `key_work_id` 等外键索引
  - 业务唯一性：参与者唯一、里程碑编号唯一等联合约束
- 推荐实践
  - 针对高选择性过滤条件增加联合索引（如部门+时间窗）
  - 定期使用 `EXPLAIN ANALYZE` 检查慢查询并调整索引
  - 只在必要时使用 `partial index` 减少维护开销（如 `is_read=false`）

---

## 5. RLS 策略统一说明

- 总体原则
  - 默认启用 RLS；只允许认证用户访问。
  - 读写分离：普通用户仅能读/写自身相关数据；管理员具备更高权限。
- 统一模型
  - 权限与角色通过 `users` 的 `role` 字段与 `permission_settings` 统一管理。
  - 各业务表基于所有者（如 `owner_id`）、参与者（`participants` 表）、部门归属（`department_id`）进行授权判定。
- 新增表策略
  - `announcements`：认证可读、管理员可写
  - `operation_logs`：本人与管理员可读；本人可插入；管理员可更新/删除
  - `key_work_progress`：报告人/所有者可写；相关参与者与同部门成员可读

---

## 6. 数据备份与恢复方案

- 备份策略
  - 删除前通过 `CREATE TABLE backup_* AS SELECT * FROM original_table` 完整备份。
  - 备份表按统一命名 `backup_*` 保留，便于检索与归档。
- 恢复方法（示例）
  - 临时恢复：`CREATE TABLE original_table AS SELECT * FROM backup_original_table;`
  - 结构化恢复：先重建原表结构（字段、约束、索引、RLS），再 `INSERT INTO original_table SELECT ... FROM backup_...`。
- 注意事项
  - 恢复前需先处理外键依赖；确保约束与索引顺序正确。
  - 恢复后进行数据一致性校验与权限回归测试。

---

## 7. 性能优化建议

- 查询层面
  - 使用分页与游标（`limit/offset` 或基于时间/ID的翻页）。
  - 避免 N+1 查询；前端聚合尽量改为服务端视图/函数。
  - 为常用统计创建过渡视图（如 `v_rewards_mapped`），必要时考虑物化视图。
- 数据层面
  - 合理规范化，必要场景使用 `jsonb` 存储扩展属性并建立 GIN 索引。
  - 定期归档历史数据至冷表或对象存储，降低主表体量。
- 维护层面
  - 定期运行慢查询审计，基于 `pg_stat_statements` 优化热点 SQL。

---

## 8. 后续维护建议

- 迁移流程
  - 采用按序编号的迁移文件（已使用 `037/038/039` 等），变更可回溯。
  - 每次迁移包含：DDL、索引、RLS 与数据迁移/备份，确保端到端一致。
- 规范约定
  - 命名：`snake_case`；主键 `id uuid default gen_random_uuid()` 优先。
  - 外键约束统一命名 `table_column_fk`，明确 `ON DELETE/UPDATE` 行为。
- 测试与验收
  - 变更后进行前端功能回归（公告、日志、进度）、RLS校验、索引性能验证。
  - 在预发环境进行数据迁移演练，出具验证报告后再发布。
- 备份管理
  - 明确备份表保留周期；到期归档或删除，保持库内整洁。

---

## 附录：现有迁移文件关键节点

- `037_cleanup_duplicate_tables.sql`：结构统一、索引补充、RLS策略调整、视图（如 `v_rewards_mapped`）。
- `038_remove_unused_duplicate_tables.sql`：重复/未用表数据备份与删除，统一命名 `backup_*`。
- `039_add_missing_feature_tables.sql`：新增 `announcements`、`operation_logs`、`key_work_progress` 及其索引与 RLS。

如需进一步扩展字段或策略（例如公告的更细粒度授权、日志的筛选字段），建议基于前端实际需求迭代迁移并进行性能对比与安全评审。
