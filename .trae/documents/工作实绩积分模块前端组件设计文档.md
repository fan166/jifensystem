# 工作实绩积分模块前端组件设计文档

## 1. 组件架构概述

工作实绩积分模块的前端组件采用模块化设计，基于现有的`PerformanceEvaluation.tsx`组件进行扩展和重构，新增权限控制和界面可见性管理功能。

## 2. 核心组件设计

### 2.1 主组件重构 - PerformanceEvaluationPage

**文件路径**: `src/pages/PerformanceEvaluation.tsx`

**主要修改内容**:

```typescript
import React, { useState, useEffect } from 'react';
import { Card, Tabs, Spin, message, Button } from 'antd';
import { SettingOutlined, UserOutlined, TeamOutlined, BarChartOutlined } from '@ant-design/icons';
import { useAuthStore } from '../stores/authStore';
import { usePermissionCheck } from '../hooks/usePermissionCheck';
import DailyEvaluationTab from '../components/performance/DailyEvaluationTab';
import AnnualEvaluationTab from '../components/performance/AnnualEvaluationTab';
import FinalScoreStatistics from '../components/performance/FinalScoreStatistics';
import PermissionSettings from '../components/performance/PermissionSettings';
import PersonalScoreView from '../components/performance/PersonalScoreView';

const PerformanceEvaluationPage: React.FC = () => {
  const { user } = useAuthStore();
  const { 
    canAccessDailyEvaluation, 
    canAccessAnnualEvaluation, 
    canManagePermissions,
    canViewStatistics 
  } = usePermissionCheck();
  const [activeTab, setActiveTab] = useState('personal');
  const [loading, setLoading] = useState(false);

  // 根据用户权限动态生成Tab项
  const getTabItems = () => {
    const items = [];

    // 个人积分查看 - 所有用户都可访问
    items.push({
      key: 'personal',
      label: <span><UserOutlined />个人积分</span>,
      children: <PersonalScoreView />
    });

    // 日常实绩评价 - 根据权限控制
    if (canAccessDailyEvaluation()) {
      items.push({
        key: 'daily',
        label: <span><UserOutlined />日常实绩评价</span>,
        children: <DailyEvaluationTab />
      });
    }

    // 年终集体测评 - 根据权限控制
    if (canAccessAnnualEvaluation()) {
      items.push({
        key: 'annual',
        label: <span><TeamOutlined />年终集体测评</span>,
        children: <AnnualEvaluationTab />
      });
    }

    // 积分统计分析 - 管理员和领导可见
    if (canViewStatistics()) {
      items.push({
        key: 'statistics',
        label: <span><BarChartOutlined />积分统计</span>,
        children: <FinalScoreStatistics />
      });
    }

    // 权限设置 - 仅管理员可见
    if (canManagePermissions()) {
      items.push({
        key: 'settings',
        label: <span><SettingOutlined />权限设置</span>,
        children: <PermissionSettings />
      });
    }

    return items;
  };

  return (
    <div className="p-6">
      <Card>
        <div className="mb-4">
          <h1 className="text-2xl font-bold">工作实绩积分管理</h1>
          <p className="text-gray-500 mt-2">
            坚持"多干多得、少干少得、不干不得"原则，科学评价工作实绩
          </p>
        </div>
        
        <Spin spinning={loading}>
          <Tabs 
            activeKey={activeTab} 
            onChange={setActiveTab}
            items={getTabItems()}
          />
        </Spin>
      </Card>
    </div>
  );
};

export default PerformanceEvaluationPage;
```

### 2.2 权限检查Hook - usePermissionCheck

**文件路径**: `src/hooks/usePermissionCheck.ts`

```typescript
import { useState, useEffect } from 'react';
import { useAuthStore } from '../stores/authStore';
import { supabase } from '../lib/supabase';

interface PermissionSettings {
  daily_evaluation_visible: boolean;
  annual_evaluation_visible: boolean;
  evaluation_result_visible: boolean;
  personal_score_visible: boolean;
  statistics_visible: boolean;
}

export const usePermissionCheck = () => {
  const { user } = useAuthStore();
  const [permissions, setPermissions] = useState<PermissionSettings>({
    daily_evaluation_visible: false,
    annual_evaluation_visible: false,
    evaluation_result_visible: false,
    personal_score_visible: true,
    statistics_visible: false
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadPermissions();
  }, [user]);

  const loadPermissions = async () => {
    try {
      const { data, error } = await supabase
        .from('permission_settings')
        .select('setting_key, is_enabled');

      if (error) throw error;

      const permissionMap = data?.reduce((acc, item) => {
        acc[item.setting_key as keyof PermissionSettings] = item.is_enabled;
        return acc;
      }, {} as PermissionSettings);

      setPermissions(prev => ({ ...prev, ...permissionMap }));
    } catch (error) {
      console.error('加载权限设置失败:', error);
    } finally {
      setLoading(false);
    }
  };

  // 检查是否为管理员角色
  const isAdmin = () => {
    return ['system_admin', 'assessment_admin'].includes(user?.role || '');
  };

  // 检查是否为领导角色
  const isLeader = () => {
    return ['leader', 'system_admin', 'assessment_admin'].includes(user?.role || '');
  };

  // 检查是否为评价人员
  const isEvaluator = () => {
    return ['evaluator', 'leader', 'system_admin', 'assessment_admin'].includes(user?.role || '');
  };

  // 日常实绩评价访问权限
  const canAccessDailyEvaluation = () => {
    if (isEvaluator()) return true;
    // 普通职工在管理员权限控制下也可以进行日常实绩评价
    if (user?.role === 'employee' && permissions.daily_evaluation_visible) return true;
    return false;
  };

  // 年终集体测评访问权限
  const canAccessAnnualEvaluation = () => {
    if (isAdmin()) return true;
    // 普通职工在管理员权限控制下也可以参与年终集体测评
    if (user?.role === 'employee' && permissions.annual_evaluation_visible) return true;
    return false;
  };

  // 权限管理功能
  const canManagePermissions = () => {
    return isAdmin();
  };

  // 统计分析查看权限
  const canViewStatistics = () => {
    if (isLeader()) return true;
    return permissions.statistics_visible;
  };

  // 个人积分查看权限
  const canViewPersonalScore = () => {
    return permissions.personal_score_visible;
  };

  // 他人积分查看权限
  const canViewOthersScore = () => {
    return isLeader();
  };

  return {
    permissions,
    loading,
    canAccessDailyEvaluation,
    canAccessAnnualEvaluation,
    canManagePermissions,
    canViewStatistics,
    canViewPersonalScore,
    canViewOthersScore,
    isAdmin,
    isLeader,
    isEvaluator,
    refreshPermissions: loadPermissions
  };
};
```

### 2.3 权限设置组件 - PermissionSettings

**文件路径**: `src/components/performance/PermissionSettings.tsx`

```typescript
import React, { useState, useEffect } from 'react';
import { Card, Switch, Form, Button, message, Divider, Space, Typography, Alert } from 'antd';
import { SaveOutlined, ReloadOutlined } from '@ant-design/icons';
import { supabase } from '../../lib/supabase';
import { useAuthStore } from '../../stores/authStore';

const { Title, Text } = Typography;

interface PermissionSetting {
  id: string;
  setting_key: string;
  is_enabled: boolean;
  description: string;
}

const PermissionSettings: React.FC = () => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [settings, setSettings] = useState<PermissionSetting[]>([]);
  const { user } = useAuthStore();

  useEffect(() => {
    loadSettings();
  }, []);

  const loadSettings = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('permission_settings')
        .select('*')
        .order('setting_key');

      if (error) throw error;

      setSettings(data || []);
      
      // 设置表单初始值
      const formValues = data?.reduce((acc, item) => {
        acc[item.setting_key] = item.is_enabled;
        return acc;
      }, {} as Record<string, boolean>);
      
      form.setFieldsValue(formValues);
    } catch (error) {
      console.error('加载权限设置失败:', error);
      message.error('加载权限设置失败');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (values: Record<string, boolean>) => {
    setSaving(true);
    try {
      const updates = Object.entries(values).map(([key, enabled]) => ({
        setting_key: key,
        is_enabled: enabled,
        updated_at: new Date().toISOString()
      }));

      const { error } = await supabase
        .from('permission_settings')
        .upsert(updates, { onConflict: 'setting_key' });

      if (error) throw error;

      message.success('权限设置保存成功');
      await loadSettings();
    } catch (error) {
      console.error('保存权限设置失败:', error);
      message.error('保存权限设置失败');
    } finally {
      setSaving(false);
    }
  };

  const permissionItems = [
    {
      key: 'daily_evaluation_visible',
      title: '日常实绩评价界面',
      description: '控制普通职工用户是否可以看到日常实绩评价功能，开启后普通职工可对其他职工进行日常实绩评价'
    },
    {
      key: 'annual_evaluation_visible',
      title: '年终集体测评界面',
      description: '控制普通职工用户是否可以参与年终集体测评，开启后普通职工可对其他职工进行年终集体测评'
    },
    {
      key: 'evaluation_result_visible',
      title: '评价结果查看',
      description: '控制普通用户是否可以查看他人的评价结果'
    },
    {
      key: 'personal_score_visible',
      title: '个人积分查看',
      description: '控制用户是否可以查看自己的积分详情'
    },
    {
      key: 'statistics_visible',
      title: '积分统计分析',
      description: '控制普通用户是否可以查看积分统计分析功能'
    }
  ];

  return (
    <div>
      <div className="mb-4">
        <Title level={3}>权限设置管理</Title>
        <Text type="secondary">
          控制普通职工用户对工作实绩积分模块各功能界面的访问权限
        </Text>
      </div>

      <Alert
        message="权限说明"
        description="系统管理员、考核办管理员和分管领导不受这些设置限制，始终拥有完整访问权限。"
        type="info"
        showIcon
        className="mb-4"
      />

      <Card loading={loading}>
        <Form
          form={form}
          layout="vertical"
          onFinish={handleSave}
        >
          {permissionItems.map((item, index) => (
            <div key={item.key}>
              <div className="flex justify-between items-start py-4">
                <div className="flex-1">
                  <Title level={5} className="mb-1">{item.title}</Title>
                  <Text type="secondary" className="text-sm">
                    {item.description}
                  </Text>
                </div>
                <Form.Item
                  name={item.key}
                  valuePropName="checked"
                  className="mb-0 ml-4"
                >
                  <Switch />
                </Form.Item>
              </div>
              {index < permissionItems.length - 1 && <Divider />}
            </div>
          ))}

          <Divider />
          
          <div className="text-right">
            <Space>
              <Button 
                icon={<ReloadOutlined />} 
                onClick={loadSettings}
                disabled={saving}
              >
                重新加载
              </Button>
              <Button 
                type="primary" 
                icon={<SaveOutlined />} 
                htmlType="submit"
                loading={saving}
              >
                保存设置
              </Button>
            </Space>
          </div>
        </Form>
      </Card>
    </div>
  );
};

export default PermissionSettings;
```

### 2.4 个人积分查看组件 - PersonalScoreView

**文件路径**: `src/components/performance/PersonalScoreView.tsx`

```typescript
import React, { useState, useEffect } from 'react';
import { Card, Row, Col, Statistic, Table, DatePicker, Space, Spin, Empty, Tag } from 'antd';
import { TrophyOutlined, CalendarOutlined, BarChartOutlined } from '@ant-design/icons';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { useAuthStore } from '../../stores/authStore';
import { supabase } from '../../lib/supabase';
import dayjs from 'dayjs';

const { RangePicker } = DatePicker;

interface PersonalScore {
  id: string;
  period: string;
  daily_score: number;
  annual_score: number;
  final_score: number;
  daily_evaluation_count: number;
  annual_evaluation_count: number;
  last_calculated_at: string;
}

interface EvaluationRecord {
  id: string;
  period: string;
  evaluation_type: 'daily' | 'annual';
  work_volume_score: number;
  work_quality_score: number;
  total_score: number;
  status: string;
  created_at: string;
  evaluator: { name: string };
}

const PersonalScoreView: React.FC = () => {
  const { user } = useAuthStore();
  const [loading, setLoading] = useState(false);
  const [scores, setScores] = useState<PersonalScore[]>([]);
  const [evaluations, setEvaluations] = useState<EvaluationRecord[]>([]);
  const [dateRange, setDateRange] = useState<[dayjs.Dayjs, dayjs.Dayjs] | null>(null);

  useEffect(() => {
    if (user?.id) {
      loadPersonalData();
    }
  }, [user, dateRange]);

  const loadPersonalData = async () => {
    setLoading(true);
    try {
      await Promise.all([
        loadPersonalScores(),
        loadPersonalEvaluations()
      ]);
    } catch (error) {
      console.error('加载个人数据失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadPersonalScores = async () => {
    let query = supabase
      .from('final_performance_scores')
      .select('*')
      .eq('user_id', user?.id)
      .order('period', { ascending: false });

    if (dateRange) {
      const [start, end] = dateRange;
      query = query
        .gte('period', start.format('YYYY-MM'))
        .lte('period', end.format('YYYY-MM'));
    }

    const { data, error } = await query;
    if (error) throw error;
    setScores(data || []);
  };

  const loadPersonalEvaluations = async () => {
    let query = supabase
      .from('performance_evaluations')
      .select(`
        *,
        evaluator:users!performance_evaluations_evaluator_id_fkey(name)
      `)
      .eq('user_id', user?.id)
      .eq('status', 'approved')
      .order('created_at', { ascending: false });

    if (dateRange) {
      const [start, end] = dateRange;
      query = query
        .gte('period', start.format('YYYY-MM'))
        .lte('period', end.format('YYYY-MM'));
    }

    const { data, error } = await query;
    if (error) throw error;
    setEvaluations(data || []);
  };

  // 计算统计数据
  const getStatistics = () => {
    if (scores.length === 0) {
      return {
        totalScore: 0,
        avgScore: 0,
        maxScore: 0,
        totalEvaluations: 0
      };
    }

    const totalScore = scores.reduce((sum, score) => sum + score.final_score, 0);
    const avgScore = totalScore / scores.length;
    const maxScore = Math.max(...scores.map(score => score.final_score));
    const totalEvaluations = evaluations.length;

    return {
      totalScore: totalScore.toFixed(1),
      avgScore: avgScore.toFixed(1),
      maxScore: maxScore.toFixed(1),
      totalEvaluations
    };
  };

  // 准备图表数据
  const getChartData = () => {
    return scores.map(score => ({
      period: score.period,
      日常评价: score.daily_score,
      年终测评: score.annual_score,
      最终积分: score.final_score
    })).reverse();
  };

  const statistics = getStatistics();
  const chartData = getChartData();

  const scoreColumns = [
    {
      title: '评价周期',
      dataIndex: 'period',
      key: 'period',
      render: (period: string) => (
        <Tag color="blue">{period}</Tag>
      )
    },
    {
      title: '日常评价积分',
      dataIndex: 'daily_score',
      key: 'daily_score',
      render: (score: number, record: PersonalScore) => (
        <div>
          <div className="font-medium">{score.toFixed(1)} 分</div>
          <div className="text-xs text-gray-500">
            基于 {record.daily_evaluation_count} 次评价
          </div>
        </div>
      )
    },
    {
      title: '年终测评积分',
      dataIndex: 'annual_score',
      key: 'annual_score',
      render: (score: number, record: PersonalScore) => (
        <div>
          <div className="font-medium">{score.toFixed(1)} 分</div>
          <div className="text-xs text-gray-500">
            基于 {record.annual_evaluation_count} 次测评
          </div>
        </div>
      )
    },
    {
      title: '最终积分',
      dataIndex: 'final_score',
      key: 'final_score',
      render: (score: number) => (
        <Tag color="green" className="text-base px-3 py-1">
          {score.toFixed(1)} 分
        </Tag>
      )
    },
    {
      title: '计算公式',
      key: 'formula',
      render: (_, record: PersonalScore) => (
        <div className="text-xs text-gray-500">
          {record.daily_score.toFixed(1)} × 80% + {record.annual_score.toFixed(1)} × 20%
        </div>
      )
    },
    {
      title: '更新时间',
      dataIndex: 'last_calculated_at',
      key: 'last_calculated_at',
      render: (date: string) => dayjs(date).format('YYYY-MM-DD HH:mm')
    }
  ];

  const evaluationColumns = [
    {
      title: '评价周期',
      dataIndex: 'period',
      key: 'period'
    },
    {
      title: '评价类型',
      dataIndex: 'evaluation_type',
      key: 'evaluation_type',
      render: (type: string) => (
        <Tag color={type === 'daily' ? 'blue' : 'orange'}>
          {type === 'daily' ? '日常评价' : '年终测评'}
        </Tag>
      )
    },
    {
      title: '工作任务量',
      dataIndex: 'work_volume_score',
      key: 'work_volume_score',
      render: (score: number) => `${score}/30`
    },
    {
      title: '工作完成质效',
      dataIndex: 'work_quality_score',
      key: 'work_quality_score',
      render: (score: number) => `${score}/20`
    },
    {
      title: '总分',
      dataIndex: 'total_score',
      key: 'total_score',
      render: (score: number) => (
        <Tag color="green">{score}/50</Tag>
      )
    },
    {
      title: '评价人',
      dataIndex: ['evaluator', 'name'],
      key: 'evaluator_name'
    },
    {
      title: '评价时间',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (date: string) => dayjs(date).format('YYYY-MM-DD')
    }
  ];

  return (
    <div>
      <div className="mb-4">
        <h3 className="text-lg font-semibold mb-2">个人工作实绩积分</h3>
        <Space>
          <span className="text-gray-600">时间范围:</span>
          <RangePicker
            picker="month"
            value={dateRange}
            onChange={setDateRange}
            placeholder={['开始月份', '结束月份']}
          />
        </Space>
      </div>

      <Spin spinning={loading}>
        {/* 统计卡片 */}
        <Row gutter={16} className="mb-6">
          <Col span={6}>
            <Card>
              <Statistic
                title="累计积分"
                value={statistics.totalScore}
                suffix="分"
                prefix={<TrophyOutlined />}
                valueStyle={{ color: '#3f8600' }}
              />
            </Card>
          </Col>
          <Col span={6}>
            <Card>
              <Statistic
                title="平均积分"
                value={statistics.avgScore}
                suffix="分"
                prefix={<BarChartOutlined />}
                valueStyle={{ color: '#1890ff' }}
              />
            </Card>
          </Col>
          <Col span={6}>
            <Card>
              <Statistic
                title="最高积分"
                value={statistics.maxScore}
                suffix="分"
                prefix={<TrophyOutlined />}
                valueStyle={{ color: '#cf1322' }}
              />
            </Card>
          </Col>
          <Col span={6}>
            <Card>
              <Statistic
                title="评价次数"
                value={statistics.totalEvaluations}
                suffix="次"
                prefix={<CalendarOutlined />}
              />
            </Card>
          </Col>
        </Row>

        {/* 积分趋势图 */}
        {chartData.length > 0 && (
          <Card title="积分趋势分析" className="mb-6">
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="period" />
                <YAxis />
                <Tooltip />
                <Line 
                  type="monotone" 
                  dataKey="最终积分" 
                  stroke="#1890ff" 
                  strokeWidth={3}
                />
                <Line 
                  type="monotone" 
                  dataKey="日常评价" 
                  stroke="#52c41a" 
                  strokeWidth={2}
                />
                <Line 
                  type="monotone" 
                  dataKey="年终测评" 
                  stroke="#faad14" 
                  strokeWidth={2}
                />
              </LineChart>
            </ResponsiveContainer>
          </Card>
        )}

        {/* 积分详情表 */}
        <Card title="积分详情" className="mb-6">
          {scores.length > 0 ? (
            <Table
              columns={scoreColumns}
              dataSource={scores}
              rowKey="id"
              pagination={{
                pageSize: 10,
                showSizeChanger: true,
                showQuickJumper: true,
                showTotal: (total) => `共 ${total} 条记录`
              }}
            />
          ) : (
            <Empty description="暂无积分记录" />
          )}
        </Card>

        {/* 评价记录表 */}
        <Card title="评价记录">
          {evaluations.length > 0 ? (
            <Table
              columns={evaluationColumns}
              dataSource={evaluations}
              rowKey="id"
              pagination={{
                pageSize: 10,
                showSizeChanger: true,
                showQuickJumper: true,
                showTotal: (total) => `共 ${total} 条记录`
              }}
            />
          ) : (
            <Empty description="暂无评价记录" />
          )}
        </Card>
      </Spin>
    </div>
  );
};

export default PersonalScoreView;
```

## 3. 组件拆分说明

### 3.1 现有组件重构

1. **PerformanceEvaluation.tsx** - 主组件重构，集成权限控制
2. **DailyEvaluationTab** - 从主组件中拆分出的日常评价管理组件
3. **AnnualEvaluationTab** - 从主组件中拆分出的年终测评管理组件
4. **FinalScoreStatistics** - 从主组件中拆分出的积分统计组件

### 3.2 新增组件

1. **PermissionSettings** - 权限设置管理组件
2. **PersonalScoreView** - 个人积分查看组件
3. **EvaluationBatchManager** - 评价批次管理组件
4. **ScoreCalculationPanel** - 积分计算面板组件
5. **ScoreCalculationDisplay** - 积分计算方式展示组件

### 3.3 积分计算展示组件设计

**文件路径**: `src/components/performance/ScoreCalculationDisplay.tsx`

```typescript
import React from 'react';
import { Card, Statistic, Divider, Typography, Tag } from 'antd';
import { CalculatorOutlined } from '@ant-design/icons';

const { Text, Title } = Typography;

interface ScoreCalculationDisplayProps {
  dailyScore: number;
  annualScore: number;
  finalScore: number;
  dailyCount: number;
  annualCount: number;
  calculationDetails?: any;
}

const ScoreCalculationDisplay: React.FC<ScoreCalculationDisplayProps> = ({
  dailyScore,
  annualScore,
  finalScore,
  dailyCount,
  annualCount,
  calculationDetails
}) => {
  return (
    <Card 
      title={
        <span>
          <CalculatorOutlined className="mr-2" />
          积分计算详情
        </span>
      }
      className="score-calculation-card"
    >
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <Statistic
          title="日常实绩评价积分"
          value={dailyScore}
          precision={2}
          suffix="分"
          valueStyle={{ color: '#1890ff' }}
        />
        <Statistic
          title="年终集体测评积分"
          value={annualScore}
          precision={2}
          suffix="分"
          valueStyle={{ color: '#52c41a' }}
        />
        <Statistic
          title="最终工作实绩积分"
          value={finalScore}
          precision={2}
          suffix="分"
          valueStyle={{ color: '#f5222d', fontSize: '24px', fontWeight: 'bold' }}
        />
      </div>
      
      <Divider />
      
      <div className="calculation-formula mb-4">
        <Title level={5}>计算公式</Title>
        <div className="bg-gray-50 p-3 rounded border">
          <Text code>
            最终积分 = 日常实绩评价积分平均值 × 80% + 年终集体测评积分平均值 × 20%
          </Text>
          <br />
          <Text code className="mt-2 block">
            {finalScore.toFixed(2)} = {dailyScore.toFixed(2)} × 0.8 + {annualScore.toFixed(2)} × 0.2
          </Text>
        </div>
      </div>
      
      <div className="calculation-details">
        <Title level={5}>计算说明</Title>
        <div className="space-y-2">
          <div className="flex justify-between items-center">
            <Text>日常实绩评价参评人数：</Text>
            <Tag color="blue">{dailyCount} 人</Tag>
          </div>
          <div className="flex justify-between items-center">
            <Text>年终集体测评参评人数：</Text>
            <Tag color="green">{annualCount} 人</Tag>
          </div>
          <div className="mt-3 p-3 bg-blue-50 rounded border border-blue-200">
            <Text className="text-sm text-blue-800">
              <strong>积分计算方式：</strong>每位普通职工的工作实绩积分 = 所有参加评分测评人员评分测评分数的总和 ÷ 参评人数（精确到小数点后两位）
            </Text>
          </div>
        </div>
      </div>
    </Card>
  );
};

export default ScoreCalculationDisplay;
```

## 4. 状态管理

### 4.1 权限状态管理

```typescript
// src/stores/permissionStore.ts
import { create } from 'zustand';
import { supabase } from '../lib/supabase';

interface PermissionState {
  permissions: Record<string, boolean>;
  loading: boolean;
  loadPermissions: () => Promise<void>;
  updatePermission: (key: string, enabled: boolean) => Promise<void>;
}

export const usePermissionStore = create<PermissionState>((set, get) => ({
  permissions: {},
  loading: false,
  
  loadPermissions: async () => {
    set({ loading: true });
    try {
      const { data, error } = await supabase
        .from('permission_settings')
        .select('setting_key, is_enabled');
      
      if (error) throw error;
      
      const permissionMap = data?.reduce((acc, item) => {
        acc[item.setting_key] = item.is_enabled;
        return acc;
      }, {} as Record<string, boolean>);
      
      set({ permissions: permissionMap });
    } catch (error) {
      console.error('加载权限失败:', error);
    } finally {
      set({ loading: false });
    }
  },
  
  updatePermission: async (key: string, enabled: boolean) => {
    try {
      const { error } = await supabase
        .from('permission_settings')
        .upsert({ setting_key: key, is_enabled: enabled });
      
      if (error) throw error;
      
      set(state => ({
        permissions: { ...state.permissions, [key]: enabled }
      }));
    } catch (error) {
      console.error('更新权限失败:', error);
      throw error;
    }
  }
}));
```

## 5. 样式和主题

### 5.1 自定义样式

```css
/* src/styles/performance.css */
.performance-evaluation {
  .permission-item {
    @apply py-4 border-b border-gray-100 last:border-b-0;
  }
  
  .score-card {
    @apply bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200;
  }
  
  .evaluation-form {
    .ant-form-item-label > label {
      @apply font-medium text-gray-700;
    }
  }
  
  .score-trend-chart {
    .recharts-tooltip-wrapper {
      @apply shadow-lg border border-gray-200 rounded-lg;
    }
  }
}

.permission-settings {
  .permission-switch {
    @apply transform transition-transform hover:scale-105;
  }
  
  .setting-description {
    @apply text-sm text-gray-600 leading-relaxed;
  }
}
```

## 6. 测试策略

### 6.1 单元测试

```typescript
// src/components/performance/__tests__/PermissionSettings.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import PermissionSettings from '../PermissionSettings';
import { useAuthStore } from '../../../stores/authStore';

// Mock Supabase
jest.mock('../../../lib/supabase');

describe('PermissionSettings', () => {
  beforeEach(() => {
    useAuthStore.setState({ 
      user: { id: '1', role: 'system_admin', name: 'Admin' } 
    });
  });

  it('应该正确渲染权限设置项', async () => {
    render(<PermissionSettings />);
    
    await waitFor(() => {
      expect(screen.getByText('日常实绩评价界面')).toBeInTheDocument();
      expect(screen.getByText('年终集体测评界面')).toBeInTheDocument();
    });
  });

  it('应该能够切换权限开关', async () => {
    render(<PermissionSettings />);
    
    const switchElement = screen.getByRole('switch', { name: /日常实绩评价/ });
    fireEvent.click(switchElement);
    
    const saveButton = screen.getByText('保存设置');
    fireEvent.click(saveButton);
    
    await waitFor(() => {
      expect(screen.getByText('权限设置保存成功')).toBeInTheDocument();
    });
  });
});
```

### 6.2 集成测试

```typescript
// src/pages/__tests__/PerformanceEvaluation.integration.test.tsx
import { render, screen } from '@testing-library/react';
import PerformanceEvaluationPage from '../PerformanceEvaluation';
import { usePermissionCheck } from '../../hooks/usePermissionCheck';

jest.mock('../../hooks/usePermissionCheck');

describe('PerformanceEvaluationPage Integration', () => {
  it('应该根据权限显示不同的标签页', () => {
    (usePermissionCheck as jest.Mock).mockReturnValue({
      canAccessDailyEvaluation: () => true,
      canAccessAnnualEvaluation: () => false,
      canManagePermissions: () => true,
      canViewStatistics: () => true
    });
    
    render(<PerformanceEvaluationPage />);
    
    expect(screen.getByText('个人积分')).toBeInTheDocument();
    expect(screen.getByText('日常实绩评价')).toBeInTheDocument();
    expect(screen.queryByText('年终集体测评')).not.toBeInTheDocument();
    expect(screen.getByText('权限设置')).toBeInTheDocument();
  });
});
```

## 7. 部署和配置

### 7.1 环境变量配置

```env
# .env.local
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
VITE_PERFORMANCE_MODULE_ENABLED=true
VITE_PERMISSION_CACHE_TTL=300000
```

### 7.2 构建配置

```typescript
// vite.config.ts
export default defineConfig({
  // ... 其他配置
  define: {
    __PERFORMANCE_MODULE_VERSION__: JSON.stringify(process.env.npm_package_version),
    __BUILD_TIME__: JSON.stringify(new Date().toISOString())
  }
});
```

## 8. 性能优化

### 8.1 组件懒加载

```typescript
// src/pages/PerformanceEvaluation.tsx
import { lazy, Suspense } from 'react';
import { Spin } from 'antd';

const PermissionSettings = lazy(() => import('../components/performance/PermissionSettings'));
const FinalScoreStatistics = lazy(() => import('../components/performance/FinalScoreStatistics'));

// 在组件中使用
<Suspense fallback={<Spin size="large" />}>
  <PermissionSettings />
</Suspense>
```

### 8.2 数据缓存策略

```typescript
// src/hooks/usePermissionCheck.ts
import { useQuery } from '@tanstack/react-query';

export const usePermissionCheck = () => {
  const { data: permissions, isLoading } = useQuery({
    queryKey: ['permissions'],
    queryFn: loadPermissions,
    staleTime: 5 * 60 * 1000, // 5分钟缓存
    cacheTime: 10 * 60 * 1000 // 10分钟缓存
  });
  
  // ... 其他逻辑
};
```